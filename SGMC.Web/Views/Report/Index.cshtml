@using SGMC.Web.Models
@using SGMC.Web.Models.Report
@model ReportViewModel
@{
    ViewData["Title"] = "Reportes y Estadísticas";
}

<h1><i class="bi bi-graph-up"></i> Reportes y Estadísticas</h1>
<p>Panel de estadísticas y generación de reportes de citas.</p>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}


<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">@Model.Statistics?.TotalAppointments</h5>
                <p class="card-text">Citas Totales</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">@Model.Statistics?.ConfirmedAppointments</h5>
                <p class="card-text">Confirmadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">@Model.Statistics?.PendingAppointments</h5>
                <p class="card-text">Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">@Model.Statistics?.CancelledAppointments</h5>
                <p class="card-text">Canceladas</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Generar Reporte
    </div>
    <div class="card-body">

        <form asp-action="Index" method="get" class="row g-3 mb-3">
            <h5>Filtrar Estadísticas y Resultados</h5>

            <div class="col-md-3">
                <label asp-for="Filter.StartDate" class="form-label">Desde</label>
                <input asp-for="Filter.StartDate" type="date" class="form-control" />
            </div>

            <div class="col-md-3">
                <label asp-for="Filter.EndDate" class="form-label">Hasta</label>
                <input asp-for="Filter.EndDate" type="date" class="form-control" />
            </div>

            <div class="col-md-3">
                <label asp-for="Filter.DoctorId" class="form-label">Doctor</label>
                <select asp-for="Filter.DoctorId" class="form-select">
                    <option value="">-- Todos los Doctores --</option>
                    @if (Model.Doctors != null)
                    {
                        @foreach (var doctor in Model.Doctors)
                        {
                            <option value="@doctor.DoctorId">@doctor.DisplayText</option>
                        }
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="Filter.StatusId" class="form-label">Estado</label>
                <select asp-for="Filter.StatusId" class="form-select">
                    <option value="">-- Todos los Estados --</option>
                    @if (Model.Statuses != null)
                    {
                        @foreach (var status in Model.Statuses)
                        {
                            <option value="@status.StatusId">@status.StatusName</option>
                        }
                    }
                </select>
            </div>

            <div class="col-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-info">
                    <i class="bi bi-filter"></i> Filtrar
                </button>
            </div>
        </form>

        <hr />

        <div class="mt-4">
            <h4>Resultados del Filtro</h4>
            @if (Model.FilteredAppointments != null && Model.FilteredAppointments.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Fecha y Hora</th>
                                <th>Paciente</th>
                                <th>Doctor</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cita in Model.FilteredAppointments)
                            {
                                <tr>
                                    <td>@cita.AppointmentDate.ToString("g")</td>
                                    <td>@cita.PatientName</td>
                                    <td>@cita.DoctorName</td>
                                    <td>
                                        <span class="badge bg-@cita.StatusColor">
                                            @cita.StatusName
                                        </span>
                                    </td>
                                    <td>
                                        @* <a asp-controller="AppointmentAdm" asp-action="Details" asp-route-id="@cita.AppointmentId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a> *@
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-light text-center">
                    No se encontraron citas con los filtros seleccionados.
                </div>
            }
        </div>

        <hr />

        <form asp-action="GeneratePdfReport" method="post">
            <h5>Descargar Reporte</h5>
            <input type="hidden" asp-for="Filter.StartDate" />
            <input type="hidden" asp-for="Filter.EndDate" />
            <input type="hidden" asp-for="Filter.DoctorId" />
            <input type="hidden" asp-for="Filter.PatientId" />
            <input type="hidden" asp-for="Filter.StatusId" /> <p>Descargue un reporte detallado basado en los filtros seleccionados arriba.</p>

            <button type="submit" class="btn btn-danger">
                <i class="bi bi-file-earmark-pdf"></i> Generar PDF
            </button>

            <button type="submit" class="btn btn-success" asp-action="GenerateExcelReport">
                <i class="bi bi-file-earmark-excel"></i> Generar Excel
            </button>
        </form>
    </div>
</div>